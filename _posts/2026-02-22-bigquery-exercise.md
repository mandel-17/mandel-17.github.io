---
Layout: post
title: "[DE zoomcamp] BigQuery 사용해보기"
toc: true
comments: true
tags:
  - Data-Engineering
  - BigQuery
categories:
  - 개발
---
### 01. OLTP vs OLAP

|            | OLTP                                      | OLAP                                         |
| ---------- | ----------------------------------------- | -------------------------------------------- |
| 목적         | 실시간 운영                                    | 계획, 문제 해결, 의사 결정 보조, 인사이트 발굴                 |
| 데이터 최신화    | 짧음, 빠른 최신화                                | 스케쥴, 배치 작업으로 주기적 최신화                         |
| 데이터베이스 디자인 | 효율성을 위한 정규화                               | 데이터 분석을 위한 비정규화                              |
| 공간 요구사항    | 히스토리 데이터를 저장할 수 있는 일반적으로 작은 규모            | 큰 데이터셋을 집계할 수 있는 큰 규모                        |
| 백업과 리커버리   | 비즈니스 연속성을 보장하고 법적 그리고 정책적 요구사항 충족하는 정기 백업 | 정기 백업 대신 OLTP 데이터 베이스에서 잃어버린 데이터를 다시 가져오는 방법 |
| 생산성 주체     | 서비스 사용자                                   | 관리자, 분석가, 경영진                                |
| 데이터 뷰      | 일별 트랜잭션 리스트                               | 대규모 데이터에 대한 복수 차원의 뷰                         |
| 사용자 예시     | 인바운드 담당, 고객, 온라인 고객 등                     | 데이터 애널리스트, 경영진, 비즈니스 애널리스트 등                 |

> 결국, OLAP는 리포트 및 데이터 분석용 데이터 저장 방식이다.

### 02. BigQuery
#### 02.1. BigQuery란
- 서버리스 데이터 웨어하우스: 서버 관리나 데이터 베이스 설치 없이 사용 가능
- 소프트웨어 뿐만 아니라 인프라 구조도 내장: 확장성과 고가용성
- 머신러닝, 지리 분석, 비즈니스 인텔리전스 내장
- 저장소에 있는 데이터를 분석하는 컴퓨터 엔진을 나눔으로써 유동성 최대화

#### 02.2. BigQuery 비용
- **On-demand pricing**: 처리된 데이터 1TB당 $5
- **Flat rate pricing**: 사전 요청된 슬롯(Slot) 수에 따라 비용을 지불 (예: 100 슬롯에 월 $2,000)

### 03. 빅쿼리 파티션
- 시간 단위 컬럼
- 정수 범위 파티셔닝
- 데이터 수집 시간 (_PARTITIONTIME)
- 시간 단위 및 수집 시간 사용시
	- 일별(디폴트)
	- 시간별
	- 월별 또는 연별
- 파티션 제한은 4000

### 4. 빅쿼리 클러스터링
- 컬럼을 관련 데이터와 같은 장소에 두기 위해서 사용
- 컬럼의 순서가 중요 
- 특정 컬럼의 순서가 데이터의 순서를 좌우함.
- 클러스터링은 필터링, 집계 성능 개선 가능.
- 1GB 미만 테이블은 파티션과 클러스터링으로 유의적인 개선이 보이지 않음.
- 최대 4개 클러스터링 컬럼을 지정 가능.
- 클러스터링 컬럼은 최상위 레벨의 중복되지 않은 컬럼이어야 함.
	- 데이터 형식: DATE, BOOL, GEOGRAPHY, INT64, NUMERIC, BIGNUMERIC, ...

### 5. 파티셔닝 vs 클러스터링
|       | 파티셔닝             | 클러스터링                  |
| ----- | ---------------- | ---------------------- |
| 손익 측면 | 사전 비용 확정         | 손익 알 수 없음              |
| 관리 측면 | 파티션 레벨 관리 필요     | 파티션 보다 세분화 필요          |
| 쿼리 측면 | 단일 컬럼 필터링  또는 집계 | 여러 특정 컬럼에 대한 필터링 또는 집계 |

### 6. BigQuery 베스트 프랙티스 (Best Practices)

- **비용 절감**: `SELECT *` 사용을 피하고, 쿼리를 실행하기 전에 가격을 확인
- **쿼리 성능 향상**:
    - 데이터를 비정규화하고 **중첩(Nested) 또는 반복(Repeated) 컬럼**을 활용
    - 조인(JOIN)을 사용하기 전에 데이터 크기를 먼저 줄이기
    - 조인 시 **가장 큰 테이블을 첫 번째**로 배치하고, 나머지는 크기 순으로 배치하는 것이 최적
    - JavaScript 사용자 정의 함수(UDF) 사용을 지양
    
### 7. BigQuery ML (BQML)

데이터를 외부 시스템으로 내보내지 않고 **SQL만으로 머신러닝 모델**을 만들고 실행 가능
- **대상**: Python이나 Java 지식이 없는 데이터 분석가와 매니저도 사용 가능
- **지원 모델 예시**: 
    - **값 예측**: 선형 회귀(Linear Regression).
    - **카테고리 분류**: 로지스틱 회귀(Logistic Regression).
    - **데이터 그룹화**: K-평균(K-means) 클러스터링.
    - **시계열 예측**: ARIMA-PLUS.